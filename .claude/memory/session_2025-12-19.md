# Session Memory: 2025-12-19

## Work Completed

### T-06: OpenAI LLM Adapter (Completed)
- Rewrote EXECPLAN_T06.md based on detailed review feedback correcting architectural issues
- Created complete LLM extraction adapter with structured outputs

**Files created:**
- `app/schemas/__init__.py` - Package exports
- `app/schemas/domain.py` - Pydantic models:
  - `PartiesInfo` - party_one, party_two, additional_parties
  - `DatesInfo` - effective_date, termination_date, term_length
  - `ClausesInfo` - governing_law, termination, confidentiality, etc.
  - `ExtractionResult` - Complete extraction with confidence and summary
- `worker/llm_extractor.py` - LLM adapter with:
  - `LLMExtractError` custom exception
  - `extract_clauses(text, client=None) -> ExtractionResult`
  - Lazy client initialization (`_get_client()`)
  - Dependency injection for testing
  - tenacity retry with exponential backoff
  - Text truncation preserving sentence boundaries
- `tests/test_llm_extractor.py` - 43 tests, **98% coverage**

**Key architectural decisions (from review feedback):**
- Use `chat.completions.create` with `response_format` (NOT `responses.create`)
- Sync function (not async) for Temporal Activity compatibility
- Only retry on specific errors: `RateLimitError`, `APIConnectionError`, `APITimeoutError`, `InternalServerError`
- Non-retryable errors (AuthenticationError, BadRequestError) fail immediately
- Lazy client initialization to avoid import-time failures
- Client injectable via parameter for testing

**Dependencies added:**
- `tenacity>=8.0.0` in pyproject.toml

**Environment variables:**
| Variable | Default | Description |
|----------|---------|-------------|
| `OPENAI_API_KEY` | (required) | API key |
| `LLM_MODEL` | `gpt-4o-mini` | Model to use |
| `LLM_MAX_CHARS` | `200000` | Max input chars |
| `LLM_TEMPERATURE` | `0.1` | Low for determinism |
| `LLM_TIMEOUT_S` | `60` | API timeout |
| `LLM_MAX_RETRIES` | `3` | Max retry attempts |

### Models.py Improvements
Applied review feedback to `app/db/models.py`:

**Changes made:**
1. Fixed misleading comments on `object_key` and `artifact_key` - clarified they should NOT include bucket prefix
2. Changed `extractions` relationship to `order_by="Extraction.created_at.desc()"` (newest first)
3. Added `latest_extraction` property to Document class
4. Added `__repr__` methods for debugging:
   - `<Document abc12345 contract.pdf [completed]>`
   - `<Extraction ext78901 doc=abc12345 model=gpt-4o-mini>`

**Design clarification:**
- `bucket` and `object_key` are NOT redundant
- `bucket = "uploads"`, `object_key = "<uuid>.pdf"` (key within bucket, no prefix)
- MinIO/S3 API needs them separate: `client.get_object(bucket, object_name)`
- Kept `content_type` for future DOCX support

## Temporal Activity Integration (T-07 Preview)

```python
@activity.defn
def llm_extract(document_id: str, text: str) -> dict:
    """Extract clauses using LLM."""
    from worker.llm_extractor import extract_clauses, LLMExtractError

    try:
        result = extract_clauses(text)
        return result.model_dump()
    except LLMExtractError as e:
        raise  # Let Temporal handle retry based on error type
```

## Test Status
- T-06 tests: 43 passed, 98% coverage on `worker/llm_extractor.py`
- Model tests pass
- All imports verified

## Files Modified This Session
- `.agent/docs/EXECPLAN_T06.md` - Rewrote with corrected architecture
- `pyproject.toml` - Added tenacity dependency
- `app/db/models.py` - Added __repr__, latest_extraction, fixed comments, desc ordering

## Files Created This Session
- `app/schemas/__init__.py`
- `app/schemas/domain.py`
- `worker/llm_extractor.py`
- `tests/test_llm_extractor.py`

---

## Session Continuation (Later in day)

### Database Layer Simplification

**Problem:** `app/db/session.py` was 102 lines with overly complex sync+async patterns.

**Changes:**
- Simplified `app/db/session.py` to 69 lines
- Primary async engine/session for FastAPI (`AsyncSessionLocal`, `get_db`)
- Minimal sync engine/session for Temporal workers (`SyncSessionLocal`, `get_sync_db`)
- Added URL conversion helpers (`_to_async_url`, `_to_sync_url`) for sqlite/postgresql
- Removed unused `app/db/repository.py`

**Test Fixes:**
- Updated `tests/conftest.py` with `sqlite_sessionmaker` fixture
- Fixed `test_activities.py` to patch `get_sync_db`
- Fixed `test_database.py` to use `SyncSessionLocal`
- Removed obsolete `test_repository.py` and `test_session_utils.py`

---

### T-10 Plan Review & Simplification

**Original plan:** Complex with HMAC authentication, Prometheus metrics, 95% coverage requirements

**Simplified to MVP:**
- Removed HMAC auth (deferred to post-MVP)
- Removed Prometheus
- Focused on core functionality already implemented

**T-10 implementation status:**
- `POST /api/extract` endpoint working
- PDF validation (content-type, size)
- Document persistence, MinIO upload, Temporal workflow start
- 6 tests passing

---

### T-11 & T-12 Implementation (Extractions Read APIs)

**Endpoints created:**
- `GET /api/extractions/{document_id}` - Latest extraction for a document
- `GET /api/extractions?page=1&page_size=10` - Paginated list

**Files created:**
- `app/schemas/api.py` - Response models (ExtractionResponse, ExtractionListResponse)
- `app/routes/__init__.py` - Package init
- `app/routes/extractions.py` - Router with async SQLAlchemy queries
- `tests/test_api_extractions.py` - 9 tests

**Files modified:**
- `app/main.py` - Added `app.include_router(extractions_router)`
- `.agent/docs/EXECPLAN_T10.md` - Simplified for MVP
- `.agent/docs/EXECPLAN_T11_T12.md` - Completed

**Features:**
- DB-only reads (no MinIO/Temporal calls)
- Pagination with defaults (page=1, page_size=10, max=100)
- Ordering by `created_at DESC`
- 404 for missing document/extraction
- Validates stored JSON against `ExtractionResult` schema

---

## Final Test Summary

```
Total: 122 tests passing

tests/test_api_extractions.py  - 9 tests (NEW)
tests/test_extract.py          - 6 tests
tests/test_health.py           - 5 tests
tests/test_activities.py       - 6 tests
tests/test_database.py         - 16 tests
tests/test_workflows.py        - 8 tests
tests/test_llm_extractor.py    - 43 tests
... and more
```

---

## Architecture Decisions

| Decision | Rationale |
|----------|-----------|
| No HMAC for MVP | Internal service, add auth when exposing externally |
| Async SQLAlchemy for FastAPI | Match existing codebase patterns |
| Sync SQLAlchemy for Temporal workers | Temporal activities are sync |
| DB-only reads for extractions | Fast, simple, no external service calls |
| 404 if no extraction | Simpler than returning document with null extraction |

---

## Commands Reference

```bash
# Run all tests
python -m pytest tests/ -v -o "addopts="

# Run specific test file
python -m pytest tests/test_api_extractions.py -v
```
